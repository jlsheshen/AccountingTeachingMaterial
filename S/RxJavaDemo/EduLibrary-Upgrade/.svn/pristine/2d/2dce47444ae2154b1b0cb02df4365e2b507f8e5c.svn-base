package com.edu.library.authorize;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.DialogInterface.OnDismissListener;
import android.util.Log;

import com.edu.library.common.PreferenceHelper;
import com.edu.library.util.MacAddressUtil;

/**
 * apk授权工具
 * 
 * @author lucher
 * 
 */
public class ApkAuthUtil {

	private static final String TAG = "ApkAuthUtil";
	private static final String PRI_KEY = "EDUCfaDBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAN09WLUOUydudbkfUB8l2leR88il5JKYfP+NP4DBWUCN6MXNvkoWAosNqgobxNm5oZDF0HcLg8v+mR3iJd5Tcen/xW3np/HIE+pR/d8hFX+0VlZ8t/0/TjTIXfhqOQa/WeNaTG3CeiMaJR8fxVlpzxJWgymxjAifkVRcXrkFmhCZAgMBAAECgYEAqFxz8iy5iQtdWQiEP3/d3cA7JdlgzVJv5UXHKqN42VBk8Ip2ogiH3OwEF3c0YYALfJGc58sCfC3+tagQq1UTHNZsnG0RKlihKIthgv4MU+bmMjDbLLeFUyCFpyTQgqhUNx7qyDPuBPxY/Dt1R7no0sSYP70SuN/ybfVyYt6YOQECQQDz/lcVUvxJC3li/fXbL67CoGHmVWXBFzlkLu1oZoBPiunrqg2MTXgE11/v4Gu2H0itdvxkVLdhu7qtcYcsFtPhAkEA6CBebIu7Q1FYRD5kzpbAlDJSxfYcwi5djRxQcxhKfSO/0Xn/rRHlEbszZEOV/3KOsJpymeLKuMJBH6bDP4lTuQJBAO4zVvcFfjEdl5MSFiy3H2j4xLrmkiFxN+FbgwDSWN/O4VHmQbXAh7RKQ2ne8ajqX7yhlgOpRSKP8M6VL/7WBmECQHiAxUQIThCmW/IhieeNby//5+SI3WkY9MvalREK3TCVrHCsqsRH8+j+i7FTPL091UFtDG1CxQahIXmy8s07F1ECQD9jEZcuzXo6VWRT9XkNNY0Zm8Fp/absPiOPBiYWMQBKDD0wcYQnfFwAZEBFSRWOyEp/47sdl/8/O5WiNCkmvUk=";

	/**
	 * 检测授权
	 * 
	 * @param context
	 * @return
	 */
	public static boolean checkAuth(Context context) {
		String verificationCode = PreferenceHelper.getInstance(context).getStringValue("verificationCode");
		String mac = MacAddressUtil.getMac(context);
		String code = SignUtils.sign(mac + context.getPackageName(), PRI_KEY);
		if (verificationCode.equals(code)) {
			Log.d(TAG, "checkAuth success");
			return true;
		} else {
			sendAuthRequst(context);
			Log.e(TAG, "checkAuth failure");
			// PreferenceHelper.getInstance(context).setStringValue("verificationCode",
			// code);
		}

		return false;
	}

	/**
	 * 申请授权
	 * 
	 * @param context
	 */
	private static void sendAuthRequst(final Context context) {
		ProgressDialog dialog = new ProgressDialog(context);
		dialog.setTitle("正在申请授权，请稍等...");
		dialog.setCanceledOnTouchOutside(false);
		dialog.show();
		dialog.setOnDismissListener(new OnDismissListener() {
			@Override
			public void onDismiss(DialogInterface dialog) {
				if (context instanceof Activity) {
					((Activity) context).finish();
				}
			}
		});

		// Intent i =
		// context.getPackageManager().getLaunchIntentForPackage(context.getPackageName());
		// i.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
		// context.startActivity(i);
	}
}
